(()=>{var e={919:(e,s,t)=>{const a=t(96),o=t(945),n=t(344),r=t(256),i=t(3),c=t(517),u={secure:!0,sameSite:"None",maxAge:864e5};e.exports={handleLogin:async(e,s)=>{const{username:t,password:r}=e.body;if(!t||!r)return s.status(400).json({message:"Username and password required."});const i=await o.findOne({username:t}).exec();if(!i)return s.status(401).json({message:"Unauthorized."});if(!await a.compare(r,i.password))return s.status(401).json({message:"Unauthorized."});const c=n.sign({UserInfo:{username:i.username,roles:i.roles}},process.env.ACCESS_TOKEN_SECRET,{expiresIn:"15m"}),d=n.sign({username:i.username},process.env.REFRESH_TOKEN_SECRET,{expiresIn:"7d"});s.cookie("jwt",d,u),s.json({accessToken:c})},handleNewUser:async(e,s)=>{const{username:t,password:n}=e.body;if(!t||!n)return s.status(400).json({message:"Username and password required."});if(await o.findOne({username:t}).exec())return s.status(409).json({message:"Username already exists"});try{const e=await a.hash(n,10),r=new o({username:t,roles:{BasicUser:1909},password:e});await r.save(),s.status(201).json({message:`User ${t} successfully created.`})}catch(e){s.status(500).json({message:e.message})}},handleRefreshToken:async(e,s)=>{const t=e.cookies;if(!t?.jwt)return s.status(401).json({message:"Unauthorized."});const a=t.jwt;n.verify(a,process.env.REFRESH_TOKEN_SECRET,(async(e,t)=>{if(e)return s.status(403).json({message:"Forbidden."});const a=await o.findOne({username:t.username}).exec();if(!a)return s.status(401).json({message:"Unauthorized."});const r=n.sign({UserInfo:{username:a.username,roles:a.roles}},process.env.ACCESS_TOKEN_SECRET,{expiresIn:"15m"});s.json({accessToken:r})}))},handleLogout:async(e,s)=>{if(!e.cookies?.jwt)return s.status(204).json({message:"204 No Content"});s.clearCookie("jwt",u),s.status(200).json({message:"Cookie cleared"})},validatePath:async(e,s)=>{const{category:t,postId:a}=e.params;if(!await r.findOne({name:c.capitalize(t)}))return console.log("cat does not exist"),s.status(404).json({message:"This resource doesn't exist"});if(a){if(24!==a.length&&12!==a.length)return console.log("wrong ID format"),s.status(404).json({message:"This resource doesn't exist"});if(!await i.findById(a))return console.log("post does not exist"),s.status(404).json({message:"This resource doesn't exist"})}return s.status(200).json({message:"Path is valid"})}}},427:(e,s,t)=>{t(185).connect(process.env.MONGODB_URL)},294:e=>{e.exports=(e,s,t,a)=>{console.error(e),t.status(500).send(e)}},981:(e,s,t)=>{const a=t(256),o=t(517);e.exports=async function(e,s,t){const{newTag:n}=e.body,r=o.capitalize(n);(await a.findOne({}).exec()).allTags.some((e=>e===r))?s.status(400).json({message:"Tag already exists"}):t()}},954:(e,s,t)=>{const a=t(738),o=a.diskStorage({}),n=a({storage:o,fileFilter:(e,s,t)=>{"image/jpeg"===s.mimetype||"image/png"===s.mimetype?t(null,!0):t({message:"Invalid file type."},!1)}});e.exports=n},870:(e,s,t)=>{const a=t(344);e.exports=(e,s,t)=>{console.log("at verifyJWT");const o=e.headers.authorization||e.headers.Authorization;if(!o?.startsWith("Bearer "))return s.status(401).json({message:"Unauthorized."});const n=o.split(" ")[1];a.verify(n,process.env.ACCESS_TOKEN_SECRET,((a,o)=>{if(a)return s.status(403).json({message:"Forbidden."});e.user=o.UserInfo.username,e.roles=o.UserInfo.roles,t()}))}},256:(e,s,t)=>{const a=t(185),o=new a.Schema({name:{type:String,required:!0,unique:!0}},{timestamps:!0}),n=a.model("Category",o);e.exports=n},998:(e,s,t)=>{const a=t(185),o=new a.Schema({imageUrl:String,publicId:String},{timestamps:!0}),n=a.model("Image",o);e.exports={Image:n,imageSchema:o}},3:(e,s,t)=>{const a=t(185),{imageSchema:o}=t(998),{tagSchema:n}=t(726),r=new a.Schema({title:String,subtitle:String,content:String,images:[o],postTags:[{type:a.Schema.Types.ObjectId,ref:"Tag"}],category:String},{timestamps:!0}),i=a.model("Post",r);e.exports=i},726:(e,s,t)=>{const a=t(185),o=new a.Schema({name:String,tag:{type:a.Schema.Types.ObjectId,ref:"Post"}},{timestamps:!0}),n=a.model("Tag",o);e.exports={Tag:n,tagSchema:o}},945:(e,s,t)=>{const a=t(185),o=new a.Schema({username:{type:String,required:[!0,"Please provide a username"],unique:!0},password:{type:String,required:[!0,"Please provide a password"]},roles:[{type:String,default:"BasicUser"}],active:{type:Boolean,default:!0}},{timestamps:!0}),n=a.model("User",o);e.exports=n},119:(e,s,t)=>{const a=new(t(860).Router),o=t(919);a.post("/auth",o.handleLogin),a.get("/auth/refresh",o.handleRefreshToken),a.post("/auth/logout",o.handleLogout),a.get("/auth/validatePath/:category",o.validatePath),a.get("/auth/validatePath/:category/:postId",o.validatePath),e.exports=a},437:(e,s,t)=>{const a=t(860),o=t(256),n=new a.Router,r=t(517),i=t(981);t(142).config(),n.get("/api/categories/:category",(async(e,s)=>{try{const t=await o.find({name:r.capitalize(e.params.category)});s.json(t)}catch(e){s.status(400).send(e)}})),n.get("/api/categories",(async(e,s)=>{try{const e=await o.findOne({name:"dummy"}).exec();s.status(200).json(e.allTags)}catch(e){s.status(400).send(e)}})),n.patch("/api/categories/tags",i,(async(e,s)=>{const{newTag:t}=e.body,a=r.capitalize(t);try{await o.findOneAndUpdate({name:"dummy"},{$push:{allTags:a}}),s.status(200).json(a)}catch(e){s.status(400).send(e)}})),n.patch("/api/categories/deleteTag",(async(e,s)=>{const{tagToDelete:t}=e.body;try{await o.findOneAndUpdate({name:"dummy"},{$pull:{allTags:t}}),s.status(200).json({deletedTag:t,message:"Tag deleted"})}catch(e){s.status(400).send(e)}})),e.exports=n},762:(e,s,t)=>{const a=new(t(860).Router),o=t(954).array("images",20),n=t(870),r=t(3),{Tag:i}=(t(256),t(726)),{Image:c}=t(998),{uploadToCloudinary:u,removeFromCloudinary:d}=t(463),p=t(517);t(142).config(),a.get("/api/posts",(async(e,s)=>{try{const e=await r.find({}).populate({path:"postTags"});s.status(200).json(e)}catch(e){s.status(404).send(e)}})),a.get("/api/posts/:category",(async(e,s)=>{try{const t=await r.find({category:p.capitalize(e.params.category)});s.status(200).json(t)}catch(e){s.status(404).send(e)}})),a.get("/api/posts/:category/:postId",(async(e,s)=>{try{const t=await r.findById(e.params.postId);s.status(200).json(t)}catch(e){s.status(400).send(e)}})),a.post("/posts",n,o,(async(e,s)=>{const{postTags:t}=e.body,a="string"==typeof t?[t]:t,o=await Promise.all(a.map((async e=>await i.find({name:e})))),n=new r(e.body);n.postTags=o.flat();const d=await n.save(),p=e.files;await Promise.all(p.map((async e=>{const s=await u(e.path,"emaJons_dev"),t=new c({publicId:s.public_id,imageUrl:s.url});await r.updateOne({_id:d._id},{$addToSet:{images:[t]}})})));const g=await r.findById(d._id).populate({path:"postTags"});s.status(200).json(g)})),a.delete("/:category/:postId",n,(async(e,s)=>{const{postId:t}=e.params;console.log("at delete",e.params);try{const t=await r.findOne({_id:e.params.postId}).exec();if(console.log(t),!t)return s.status(204).json({message:"No post found with this id."});const a=t.images.map((e=>e.publicId));a.length&&await d(a),await t.deleteOne(),s.status(200).json({message:"post deleted successfully"})}catch(e){s.status(400).send(e)}})),a.patch("/posts/:postId/edit",n,o,(async(e,s)=>{const t=Object.assign({},e.body),a="string"==typeof t.postTags?[t.postTags]:t.postTags,o=await Promise.all(a.map((async e=>await i.find({name:e}))));t.postTags=o.flat(),console.log(t);const n=await r.findOneAndUpdate({_id:e.params.postId},{$set:t},{new:!0}).exec();if(!n)return s.status(204).json({message:"No post found with this id."});const d=e.files;await Promise.all(d.map((async e=>{const s=await u(e.path,"emaJons_dev"),t=new c({publicId:s.public_id,imageUrl:s.url});await r.updateOne({_id:n._id},{$addToSet:{images:[t]}})})));const p=await r.findById(n._id).populate({path:"postTags"});s.status(200).json(p)})),e.exports=a},979:(e,s,t)=>{const a=t(860).Router(),o=t(919);a.post("/register",o.handleNewUser),e.exports=a},532:(e,s,t)=>{const a=t(119),o=t(762),n=t(437),r=t(979),i=t(757);e.exports={authRouter:a,postRouter:o,tagRouter:i,registerRouter:r,categoryRouter:n}},757:(e,s,t)=>{const a=new(t(860).Router),{Tag:o}=t(726);t(517),t(981),t(142).config(),a.post("/api/tags",(async(e,s)=>{try{const t=new o(e.body),a=await t.save();s.status(200).json(a)}catch(e){s.status(400).send(e)}})),a.get("/api/tags",(async(e,s)=>{try{const e=await o.find();s.status(200).json(e)}catch(e){s.status(400).send(e)}})),a.patch("/api/tags/deleteTag",(async(e,s)=>{try{const{tagToDelete:t}=e.body,a=await o.findOneAndDelete({name:t});s.status(200).json({deletedTag:a,message:"Tag deleted"})}catch(e){s.status(400).send(e)}})),e.exports=a},463:(e,s,t)=>{const a=t(518);t(142).config(),a.config({cloud_name:process.env.CLOUDINARY_CLOUD_NAME,api_key:process.env.CLOUDINARY_API_KEY,api_secret:process.env.CLOUDINARY_API_SECRET}),e.exports={uploadToCloudinary:(e,s)=>a.v2.uploader.upload(e,{folder:s}).then((e=>({url:e.url,public_id:e.public_id}))).catch((e=>{console.log(e)})),removeFromCloudinary:async e=>{await a.v2.api.delete_resources(e,((e,s)=>{console.log(e,s)}))}}},96:e=>{"use strict";e.exports=require("bcrypt")},518:e=>{"use strict";e.exports=require("cloudinary")},710:e=>{"use strict";e.exports=require("cookie-parser")},582:e=>{"use strict";e.exports=require("cors")},142:e=>{"use strict";e.exports=require("dotenv")},860:e=>{"use strict";e.exports=require("express")},344:e=>{"use strict";e.exports=require("jsonwebtoken")},517:e=>{"use strict";e.exports=require("lodash")},185:e=>{"use strict";e.exports=require("mongoose")},738:e=>{"use strict";e.exports=require("multer")},17:e=>{"use strict";e.exports=require("path")}},s={};function t(a){var o=s[a];if(void 0!==o)return o.exports;var n=s[a]={exports:{}};return e[a](n,n.exports,t),n.exports}(()=>{const e=t(860);t(427);const s=t(532),a=t(294),o=t(17),n=t(582),r=t(710),i=e();i.use(n()),i.use(e.json()),i.use(r()),i.set("view engine","ejs"),i.set("views","./src/views"),i.use(e.static("public")),i.use(e.urlencoded({extended:!0})),i.use(s.authRouter,s.postRouter,s.tagRouter,s.registerRouter,s.categoryRouter),i.use(a),i.use("/assets",e.static(o.join(__dirname,"../public"))),i.get("/*",((e,s)=>{try{s.render("home")}catch(e){s.status(400).send(e)}})),i.listen(3e3)})()})();